<?php 
	include 'header.phtml';
?>
<link rel="stylesheet" type="text/css" href="<?=URL_ROOT?>/app-assets/plugin/typeahead.js-master/dist/typehead-min.css" >
  <div class="app-content content ">
        <div class="content-wrapper container-fluid p-0">
            <div class="content-body"> 
                <div class="container-fluid">
                    <div class="container-venta">
                        <div class="w-100 card">
                            <div class="card-header-venta fw-bolder fs-5 text-uppercase" data-bs-toggle="collapse" href="#cliente" role="button" aria-expanded="true" aria-controls="cliente" style="background-color: #04aa6d; color:white;" id="header-cliente"><span><i class="fas fa-caret-down ms-1 me-1"></i>&nbsp;Cliente</span></div>
                            <div class="card-body" id="cliente">
                                <div class="d-flex">
                                    <div class="col-5">
                                        <label for="buscador" class="form-label fw-bolder fs-5">Nombre del cliente</label>
                                        <input type="text" id="buscador" class="form-control" placeholder="Público en General">
                                        <input type="hidden" id="venta_cliente_id" value="1">
                                    </div>
                                    <div class="col-2 text-center">
                                        <label for="" class="form-label fw-bolder fs-5 text-center">Venta</label>
                                        <div class="mt-1">
                                            <input type="radio" id="contado" name="venta-tipo" class="radio" value="1" checked>
                                            <label for="contado">Contado</label> &nbsp;
                                            <input type="radio" id="credito" name="venta-tipo" class="radio ventaCredito hidden" value="2">
                                            <label for="credito" class="ventaCredito hidden">Crédito</label>
                                        </div>
                                    </div>
                                    <div class="col-5 text-center">
                                        <label for="descuento" class="form-label fw-bolder fs-5">Descuento %</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <input class="form-check-input mt-0" type="checkbox" id="aplicar" data-toogle="tooltip" title="Aplicar descuento" disabled>
                                            </div>
                                            <input type="number" min="0" max="100" class="form-control text-end" id="descuento" value="0">
                                        </div>
                                    </div>
                                    <!-- <input type="hidden" id="venta_id" value="0"> -->
                                </div>
                            </div>
                        </div>
                        <div class="d-flex separar">
                            <div class="col-7 card shadow-lg">
                                <div class="card-header-venta fw-bolder fs-5 text-uppercase" id="header-productos" style="background-color: #04aa6d; color:white;">productos</div>
                                <div class="card-body">
                                    <div class="form-group row d-flex">
                                        <div class="col-8 busqueda hidden">
                                            <div class="row">
                                                <label class="col-4 label-control text-end" for="bus">Buscar</label>
                                                <div class="col-8">
                                                    <input class="form-control input-sm" id="bus" placeholder="Buscar por clave o descripción"></input>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-4 busqueda hidden">
                                            <div class="row" style="justify-content: end;">
                                                <label class="col-6 label-control text-end" for="cuantos">Mostrar</label>
                                                <div class="col-6">
                                                    <select class="form-control" id="cuantos"><option value="10">10</option><option value="25">25</option><option value="50">50</option><option value="100">100</option></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-100 d-flex">
                                        <table id="tbl-prods" class="table m-0 w-100 table-sm">
                                            <thead>
                                                <tr class="text-center">
                                                    <th>venta</th>
                                                    <th>Stock</th>
                                                    <th>Clave</th>
                                                    <th>Descripción</th>
                                                    <th>Medida</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-5 card shadow-lg" style="width: calc(41.333% - 1rem);">
                                <div class="card-header-venta fw-bolder fs-5 text-uppercase" id="header-rangos" style="background-color: #04aa6d; color:white;">rangos de precios</div>
                                <div class="card-body">
                                    <div class="d-flex">
                                        <div>
                                            <center><h5 class="name_prod"></h5></center><br>
                                            <table id="tbl-rangos_precios" class="table">
                                                <thead class="table-light">
                                                    <tr class="text-center">
                                                        <th>Tipo</th>
                                                        <th>Hasta</th>
                                                        <th>Precio</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Menudeo</td>
                                                        <td><input type="text" class="form-control text-end deshabilitado" id="precio-menudeo" placeholder="0" readonly></td>
                                                        <td>
                                                            <div class="input-group">
                                                                <div class="input-group-text">
                                                                    <small>$</small>
                                                                </div>
                                                                <input type="text" class="form-control text-end deshabilitado" id="precio-precio_menudeo" placeholder="0.00" readonly>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Medio mayoreo</td>
                                                        <td><input type="text" class="form-control text-end deshabilitado" id="precio-medio" placeholder="0" readonly></td>
                                                        <td>
                                                            <div class="input-group">
                                                                <div class="input-group-text">
                                                                    <small>$</small>
                                                                </div>
                                                                <input type="text" class="form-control text-end deshabilitado" id="precio-precio_medio" placeholder="0.00" readonly>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Mayoreo</td>
                                                        <td><input type="text" class="form-control text-end deshabilitado" id="precio-mayoreo" placeholder="0" readonly></td>
                                                        <td>
                                                            <div class="input-group">
                                                                <div class="input-group-text">
                                                                    <small>$</small>
                                                                </div>
                                                                <input type="text" class="form-control text-end deshabilitado" id="precio-precio_mayoreo" placeholder="0.00" readonly>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>Distribuidor</td>
                                                        <td><input type="text" class="form-control text-end deshabilitado" id="precio-distribuidor" placeholder="0" readonly></td>
                                                        <td>
                                                            <div class="input-group">
                                                                <div class="input-group-text">
                                                                    <small>$</small>
                                                                </div>
                                                                <input type="text" class="form-control text-end deshabilitado" id="precio-precio_distribuidor" placeholder="0.00" readonly>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="w-100 card">
                            <div class="card-header-venta fw-bolder fs-5 text-uppercase" id="header-prods_agregados" style="background-color: #04aa6d; color:white;">productos agregados</div>
                            <div class="card-body">
                                <table id="tbl-detalles" class="table table-hover table-striped m-0 w-100 mw-100 table-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-start" width="10%">Cantidad</th>
                                            <th class="text-start" width="45%">Concepto</th>
                                            <th width="15%">P. Unitario</th>
                                            <th width="15%">Total</th>
                                            <th width="15%">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    <tr class="nodata">
                                        <td colspan="9" class="text-center p-10 nodata">No se han agregado productos a la venta</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="d-flex separar">
                            <div class="col-8 card">
                                <div class="form-group row m-1">
                                    <label class="form-label fw-bolder fs-5" for="venta-comentarios">Comentarios</label><br>
                                    <textarea name="" id="venta-comentarios" rows="15"></textarea>
                                </div>
                            </div>
                            <div class="col-4 card" style="width: calc(33.333% - 1rem);">
                                <div class="form-group row m-1">
                                    <div class="mt-1 mb-1">
                                        <label class="form-label fw-bolder fs-5" for="venta-subtotal">Subtotal</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <span><i class="fas fa-dollar-sign"></i></span>
                                            </div>
                                            <input type="text" class="form-control text-end" id="venta-subtotal" readonly>
                                        </div>
                                    </div>
                                    <div class="mb-1">
                                        <label class="form-label fw-bolder fs-5" for="venta-descuento">Descuento</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <span>%</span>
                                            </div>
                                            <input type="text" class="form-control text-end" id="venta-descuento" readonly>
                                        </div>
                                    </div>
                                    <div class="mb-1 ventaPagado hidden">
                                        <label class="form-label fw-bolder fs-5" for="venta-pagado">Pagado</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <span><i class="fas fa-dollar-sign"></i></span>
                                            </div>
                                            <input type="text" class="form-control text-end" id="venta-pagado" readonly>
                                        </div>
                                    </div>
                                    <div class="mb-1">
                                        <label class="form-label fw-bolder fs-5" for="venta-total">Total</label>
                                        <div class="input-group">
                                            <div class="input-group-text">
                                                <span><i class="fas fa-dollar-sign"></i></span>
                                            </div>
                                            <input type="text" class="form-control text-end" id="venta-total" placeholder="0.00" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="buttonsEnd">
                            <button type="button" class="btn btn-outline-secondary mb-1" id="btnCancel">Cancelar</button>
                            <button type="button" class="btn btn-new-info mb-1 data-submit" id="btnContinuar">Cobrar</button>
                            <input type="hidden" id="prod_id" value="0">
                        </div>
                    </div>
                    <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="frm-pago">
                        <div class="modal-dialog">
                            <form class="modal-content pt-0">
                                <div class="modal-header mb-1">
                                    <h4 class="modal-title text-uppercase"></h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body flex-grow-1 form-horizontal">
                                    <div class="mb-1 form-group row">
                                        <div class="w-100 mb-1">
                                            <label class="form-label fw-bolder fs-5" for="pago-total">Total</label>
                                            <input type="text" class="form-control deshabilitado" id="pago-total" readonly>
                                        </div>
                                        <div class="w-100 mb-1 infoPago">
                                            <label class="form-label fw-bolder fs-5" for="pago-recibido">Pago</label>
                                            <input type="text" class="form-control" id="pago-recibido" placeholder="0.00">
                                        </div>
                                        <div class="w-100 mb-1 infoPago">
                                            <label class="form-label fw-bolder fs-5" for="pago-cambio">Cambio</label>
                                            <input type="text" class="form-control deshabilitado" id="pago-cambio" placeholder="0.00" readonly>
                                        </div>
                                        <div class="w-100">
                                            <label class="form-label fw-bolder fs-5" for="pago-forma_pago">Método de Pago</label>
                                            <select class="form-control" id="pago-forma_pago">
                                                <option value="0" disabled>Seleccione una opción</option>
                                                <option value="1">Efectivo</option>
                                                <option value="2" class="hidden">Saldo a favor</option>
                                                <option value="3">Tarjeta</option>
                                                <option value="4">Transferencia</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="buttonsEnd">
                                        <button type="reset" class="btn btn-outline-secondary mb-1" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-success mb-1" id="btnSave">Guardar</button>
                                        <input type="hidden" id="pago_id" value="0">
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" id="frm-cantidad">
                        <div class="modal-dialog modal-sm modal-dialog-centered">
                            <form class="modal-content pt-0">
                                <div class="modal-header" style="background-color: #04aa6d;">
                                    <h5 class="modal-title text-uppercase text-center text-white fw-bolder">número de piezas</h5>
                                    <button type="button" class="btn-sm btn-close" data-bs-dismiss="modal" aria-label="Close" style="background-color: #04aa6d;"></button>
                                </div>
                                <div class="modal-body flex-grow-1 form-horizontal">
                                    <div class="row text-center">
                                        <p></p>
                                        <div class="px-4">
                                            <input type="number" class="form-control" id="prod_cantidad" value="1" min="1" palceholder="Cantidad a agregar">
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer justify-content-center py-0">
                                    <input type="hidden" id="prod_cantidad_add" value="0">
                                    <button type="button" class="btn btn-success mb-1" id="btnAddCant" data-kilo="0">AGREGAR</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php
  include 'footer.phtml';
?>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

<script>
    $(function(){
        var apiUrl = '<?= URL_ROOT ?>/',
            aplicar = 0,
            desc_cli = 0,
            continuar = true,
            tipo = 1,
            selectedRowIndex = -1,
            tabla_prods;

            let editCant = false,
            contador = 0;

        $('.title h2').html('Segunda Venta');
        let findClientes = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: `${apiUrl}/cliente/getBy/%QUERY`,
                wildcard: '%QUERY'
            }
        });

        $('#buscador').typeahead(
            {hint: true, highlight: true, minLength: 2}, 
            {display: 'cliente', source: findClientes}
        );
        
        $('#buscador').bind('typeahead:select', function(ev, suggestion) {
            let cliente_id = suggestion.id;
            if($.isNumeric(cliente_id) && cliente_id > 0){
                $('#buscador').val(suggestion.cliente);
                $('#venta_cliente_id').val(cliente_id).trigger('change');
            }
        });
        getItems('tbl-prods');

        document.addEventListener ("keydown", function (e) {
            const tag = e.target.tagName.toLowerCase();
            const isInput = tag === 'input' || tag === 'textarea' || e.target.isContentEditable;
            const modalCantidadVisible = $('#frm-cantidad').is(':visible');
            const modalPagoVisible = $('#frm-pago').is(':visible');

            if (e.which === 13 && modalCantidadVisible) {
                e.preventDefault();
                $('#btnAddCant').trigger('click');
                return;
            }

            if (e.which === 27) {
                $('#frm-cantidad').modal('hide');
                $('#frm-pago').modal('hide');
                return;
            }

            if (isInput) return;
            
            if(e.which === 13){
                if(modalPagoVisible){
                    $('#pago-forma_pago').focus();
                } else if (!editCant) {
                    addSelected(selectedRowIndex);
                }else{
                    contador += 1;
                    selectInput(contador);
                }
            }

            var rows = getRows();
            var rowCount = rows.length;
            if (e.key === "ArrowDown") {
                e.preventDefault();
                editCant = false;
                if (selectedRowIndex < rowCount - 1) {
                    selectRow(selectedRowIndex + 1);
                } else if (selectedRowIndex != -1 && rowCount > 0) {
                    selectRow(0);
                }
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                editCant = false;
                if (selectedRowIndex > 0) {
                    selectRow(selectedRowIndex - 1);
                } else if (selectedRowIndex != -1 && rowCount > 0) {
                    selectRow(rowCount - 1);
                }
            }

            if (e.key === "ArrowRight") {
                e.preventDefault();
                editCant = false;
                tabla_prods.page('next').draw('page');
                selectedRowIndex = 0;
                selectRow(selectedRowIndex);
            } else if (e.key === "ArrowLeft") {
                e.preventDefault();
                editCant = false;
                tabla_prods.page('previous').draw('page');
                selectedRowIndex = 0;
                selectRow(selectedRowIndex);
            }

            if (e.which === 9 && !e.shiftKey) {
                e.preventDefault();
                if (modalPagoVisible) {
                    $('#pago-recibido').focus();
                } else {
                    editCant = true;
                    selectInput(contador);
                }
            }

            if(e.which === 9 && e.shiftKey){
                e.preventDefault();
                editCant = true;
                contador -= 1;
                if(contador > 0){
                    selectInput(contador);
                }
            }

            if (event.key === 'F1') {
                event.preventDefault();
                $('#btnContinuar').trigger('click');
            }

            if (event.key === 'F2') {
                event.preventDefault();
                $('#btnSave').trigger('click');
            }
        });

        $('#btnCancel').click(function(e){
            e.preventDefault()
            $.blockUI()
            swal({
                title: "SALIR",
                text: "Se perderán todos los datos de la venta</br>¿Qué desea hacer?",
                type: "warning",
                html: true,
                showCancelButton: true,
                cancelButtonText: "Permanecer",
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Salir",
                closeOnConfirm: true 
            }, function(respuesta) {
                if(respuesta) {
                    window.location.href = '<?= URL_ROOT ?>/venta/cliente'
                }
                $.unblockUI();
            })
        })

        $('#venta_cliente_id').on('change', function(){
            $.blockUI()
            id = $(this).val()
            $('#aplicar').prop('checked', false).trigger('change')
            if(id != 1){
                $.get(apiUrl+'cliente/get/'+id, function(resp){
                    desc_cli = resp.result.descuento; 
                    $('#aplicar').attr('disabled', false).prop('disabled', false)
                    $('.ventaCredito').removeClass('hidden')
                    $('#descuento').val(resp.result.descuento)
                    tipo = 2;
                    $("input[type='radio'][name='venta-tipo']").prop('disabled', false).prop('disabled', false);
                    $("input[type='radio'][name='venta-tipo'][value='"+tipo+"']").prop('checked',true).trigger('change');
                },'json')
                $('#btnContinuar').html('Guardar')
                $.unblockUI()
            }else{
                desc_cli = 0; tipo = 1;
                $('#header-cliente').css('background-color', '#04aa6d')
                $('#header-productos').css('background-color', '#04aa6d')
                $('#header-rangos').css('background-color', '#04aa6d')
                $('#header-prods_agregados').css('background-color', '#04aa6d')
                $('#header-pagos').css('background-color', '#04aa6d')
                $('#aplicar').attr('disabled', true).prop('disabled', 'disabled').prop('checked', false)
                $('.ventaCredito').addClass('hidden')
                $('#descuento').val('')
                $("input[type='radio'][name='venta-tipo'][value='1']").prop('checked',true);
                $('#btnContinuar').html('Cobrar')
                $.unblockUI()
            }
        })

        $('input[type=radio][name=venta-tipo]').on('change', function(){
            tipo = $(this).val()
            if(tipo == 1){
                $('#btnContinuar').html('Cobrar')
                $('#header-cliente').css('background-color', '#04aa6d')
                $('#header-productos').css('background-color', '#04aa6d')
                $('#header-rangos').css('background-color', '#04aa6d')
                $('#header-prods_agregados').css('background-color', '#04aa6d')
                $('#header-pagos').css('background-color', '#04aa6d')
            }else{
                $('#btnContinuar').html('Guardar')
                $('#header-cliente').css('background-color', '#000099')
                $('#header-productos').css('background-color', '#000099')
                $('#header-rangos').css('background-color', '#000099')
                $('#header-prods_agregados').css('background-color', '#000099')
                $('#header-pagos').css('background-color', '#000099')
            }
        })

        $('#aplicar').change(function(){
            aplicar = $(this).is(':checked') ? 1 : 0;
            if(aplicar){
                $('#aplicar').removeClass('deshabilitado').attr('disabled', false).prop('disabled', false)
                $('#descuento').val(desc_cli).removeClass('deshabilitado').attr('disabled', false).prop('disabled', false);
                $('#venta-descuento').val(desc_cli)
                getTotales()
            }else{
                $('#descuento').val('').addClass('deshabilitado').attr('disabled', true).prop('disabled', 'disabled')
                $('#venta-descuento').val(0)
                getTotales()
            }
        })

        $('#tbl-prods').on('click', '.btnAdd', function(e){
            e.preventDefault();
            $.blockUI();
            delSeleccion();
            agregar = true;
            prod_id = $(this).data('id')
            es_kilo = $(this).data('kilo')
            tr = $(this).closest('tr');
            $(tr).addClass('selected');
            selectedRowIndex = $(tr).index();
            clave = $(tr).find('td:eq(1)').text();
            desc = $(tr).find('td:eq(2)').text();
            concepto = '('+clave+') '+desc;
            if($('#tbl-detalles tbody tr').length != 0) {
                $('.nodata').remove()
                $.each($('#tbl-detalles tbody tr'), function(index, tr){
                    if($(tr).data('producto_id') == prod_id){
                        toastr['info']('El producto ya está agregado en la venta, modifique la cantidad')
                        agregar = false;
                        $(tr).find('td:eq(0) input').focus();
                        $.unblockUI()
                    }
                })
            }else{
                $('#tbl-detalles tbody').append('<tr class="nodata"><td colspan="9" class="text-center p-10 nodata">No se han agregado productos a la venta</td></tr>')
            }
           
            if(agregar){
                if(es_kilo == 0){
                    $.get(apiUrl+'prod_stock/getStock/'+prod_id, function(respStock){
                        if(respStock){
                            if(respStock.final >= 1){
                                stockDisp = parseFloat(respStock.final)
                                let stock = (stockDisp.toFixed(1)).toString();
                                $('#frm-cantidad p').html(`<b>CLAVE: ${clave}</b>`);
                                $('#prod_cantidad_add').val(prod_id);
                                $('#prod_cantidad').data('kilo', es_kilo);
                                $('#prod_cantidad').data('clave', clave);
                                $('#prod_cantidad').data('desc', desc);
                                $('#frm-cantidad').modal('show');
                                $.unblockUI()
                            }else{
                                toastr['error']('¡Stock insuficiente!', 'No hay suficiente stock del producto')
                                $.unblockUI()
                            }
                        }else{
                            toastr['error']('¡Stock insuficiente!', 'No hay suficiente stock del producto')
                            $.unblockUI()
                        }
                    },'json')
                }else{
                    $.get(apiUrl+'prod_stock/getStockByKilo/'+prod_id+'/1', function(respStock){
                        if(respStock.response){
                            stockDisp = parseFloat(respStock.final)
                            let stock = (stockDisp.toFixed(1)).toString();
                            $('#frm-cantidad p').html(`<b>CLAVE: ${clave}</b>`);
                            $('#prod_cantidad_add').val(prod_id);
                            $('#prod_cantidad').data('kilo', es_kilo);
                            $('#prod_cantidad').data('clave', clave);
                            $('#prod_cantidad').data('desc', desc);
                            $('#frm-cantidad').modal('show');
                            $.unblockUI()
                        }else{
                            toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                            if($('#tbl-detalles tbody tr').length == 0) 
                                $('#tbl-detalles tbody').append('<tr class="nodata"><td colspan="9" class="text-center p-10 nodata">No se han agregado productos a la venta</td></tr>')
                            $.unblockUI()
                        }
                    },'json')
                }
            }
        })

        $('#frm-cantidad').on('shown.bs.modal', function () {
            $('#prod_cantidad').val(1).focus().select();
        });

        $('#tbl-detalles').on('change', '.cant', function(){
            $.blockUI()
            elem = $(this)
            cantidad = parseFloat($(elem).val())
            tr = $(elem).closest('tr')
            prod_id = $(tr).data('producto_id')
            detalle_id = $(tr).data('detalle_id')
            clave = $(tr).data('clave')
            kilo = $(tr).data('kilo')
            if(cantidad < 1 && !kilo){
                toastr["error"]("¡Error!", "No se puede vender menos de 1 pieza")
                $(elem).val('1.0')
                $.unblockUI()
            }

            if(kilo == 0){
                $.get(apiUrl+'prod_stock/getStock/'+prod_id, function(resp){
                    if(cantidad <= resp.final){
                        let cant = (cantidad.toFixed(1)).toString()
                        $.get(apiUrl+'producto/getPrecioByCant/'+prod_id+'/'+cantidad, function(resp){
                            precio = resp != null ? parseFloat(resp).toFixed(2) : parseFloat(0).toFixed(2) 
                            total = parseFloat(precio*cantidad).toFixed(2)
                            $(tr).find('.precio').html('$ '+precio)
                            $(tr).find('.total').html('$ '+total)
                            getTotales()
                        },'json');
                    }else{
                        toastr["error"](`Disponible: ${resp.final} pzas.`, "No hay suficiente stock del producto")
                        elem.focus().select();
                    }
                    $.unblockUI()
                },'json')
            }else{
                $.get(apiUrl+'prod_stock/getStockByKilo/'+prod_id+'/'+cantidad, function(resp){
                    if(resp.response){
                        if(cantidad <= parseFloat(resp.max)){
                            $.get(apiUrl+'producto/getPrecioByCant/'+prod_id+'/'+cantidad, function(resp){
                                precio = resp != null ? parseFloat(resp).toFixed(2) : parseFloat(0).toFixed(2) 
                                total = parseFloat(precio*cantidad).toFixed(2)
                                cant = cantidad.toFixed(3).toString()
                                $(tr).find('.precio').html('$ '+precio)
                                $(tr).find('.total').html('$ '+total)
                                getTotales()
                            },'json');
                        }else{
                            toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                            $(tr).find('.cant').val(resp.max).trigger('change');
                        }
                    }else{
                        toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                    }
                    $.unblockUI()
                },'json')
            }
        })

        $('body').on('change', '#prod_cantidad', function(){
            let elem = $(this)
            let cantidad = parseFloat($(elem).val());
            let prod_id = $('#prod_cantidad_add').val();
            let kilo = $('#prod_cantidad').data('kilo');
            $('#btnAddCant').attr('disabled', false).prop('disabled', false).removeClass('deshabilitado');
            if(cantidad < 1 && kilo == 0){
                toastr["error"]("¡Error!", "No se puede vender menos de 1 pieza")
                $(elem).val('1.0')
                $('#btnAddCant').attr('disabled', true).prop('disabled', true).addClass('deshabilitado');
                $.unblockUI()
            }

            if(kilo == 0){
                $.get(`${apiUrl}prod_stock/getStock/${prod_id}`, function(resp){
                    if(cantidad > resp.final){
                        toastr["error"](`Disponible: ${resp.final} pzas.`, "No hay suficiente stock del producto");
                        elem.focus().select();
                        $('#btnAddCant').attr('disabled', true).prop('disabled', true).addClass('deshabilitado');
                    }
                    $.unblockUI()
                },'json')
            }else{
                $.get(`${apiUrl}prod_stock/getStockByKilo/${prod_id}/${cantidad}`, function(resp){
                    if(resp.response){
                        if(cantidad > parseFloat(resp.max)){
                            toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                            $('.cant').val(resp.max).trigger('change');
                            $('#btnAddCant').attr('disabled', true).prop('disabled', true).addClass('deshabilitado');
                        }
                    }else{
                        toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                        $('#btnAddCant').attr('disabled', true).prop('disabled', true).addClass('deshabilitado');
                    }
                    $.unblockUI();
                },'json')
            }
        });

        $('#btnAddCant').on('click', function(e){
            e.preventDefault();
            let elem = $('#prod_cantidad');
            let cantidad = parseFloat($(elem).val());
            let prod_id = $('#prod_cantidad_add').val();
            let kilo = $('#prod_cantidad').data('kilo');
            let clave = $('#prod_cantidad').data('clave');
            let desc = $('#prod_cantidad').data('desc');
            if(cantidad < 1 && kilo == 0){
                toastr["error"]("¡Error!", "No se puede vender menos de 1 pieza")
                $(elem).val('1.0')
                $.unblockUI()
            }

            if(kilo == 0){
                $.get(`${apiUrl}prod_stock/getStock/${prod_id}`, function(respStock){
                    let stockDisp = parseFloat(respStock.final)
                    if(cantidad <= stockDisp){
                        let stock = (stockDisp.toFixed(1)).toString()
                        $.get(apiUrl+'producto/getPrecioByCant/'+prod_id+'/'+cantidad, function(resp){
                            precio = resp != null ? parseFloat(resp).toFixed(2) : parseFloat(0).toFixed(2) 
                            total = parseFloat(precio*cantidad).toFixed(2)
                            data = {
                                'detalle_id': '', 
                                'producto_id': prod_id, 
                                'cantidad': cantidad, 
                                'stock': stock, 
                                'clave': clave, 
                                'desc': desc, 
                                'concepto': `(${clave}) ${desc}`, 
                                'precio': precio, 
                                'total': total, 
                                'es_kilo': '0',
                                'stock': stock,
                            }
                            addDetalle(data)
                            getTotales()
                        },'json')
                    }else{
                        toastr["error"](`Disponible: ${stockDisp} pzas.`, "No hay suficiente stock del producto");
                        elem.focus().select();
                    }
                    $.unblockUI()
                },'json')
            }else{
                $.get(`${apiUrl}prod_stock/getStockByKilo/${prod_id}/${cantidad}`, function(respStock){
                    if(respStock.response){
                        if(cantidad <= parseFloat(respStock.max)){
                            $.get(apiUrl+'producto/getPrecioByCant/'+prod_id+'/'+cantidad, function(resp){
                                precio = resp != null ? parseFloat(resp).toFixed(2) : parseFloat(0).toFixed(2) 
                                total = parseFloat(precio*cantidad).toFixed(2)
                                data = {
                                    'detalle_id': '', 
                                    'producto_id': prod_id, 
                                    'cantidad': cantidad, 
                                    'clave': clave, 
                                    'desc': desc, 
                                    'concepto': `(${clave}) ${desc}`, 
                                    'precio': precio, 
                                    'total': total, 
                                    'es_kilo': '1',
                                    'stock': respStock.max,
                                }
                                
                                addDetalle(data)
                                getTotales() 
                            }, 'json');
                            $.unblockUI()
                        }else{
                            toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                            $('.cant').val(resp.max).trigger('change');
                        }
                    }else{
                        toastr["error"]("¡Stock insuficiente!", "No hay suficiente stock del producto")
                    }
                    $.unblockUI();
                },'json')
            }
        });

        $('#tbl-detalles').on('click', '.btnDelDet', function(e){
            e.preventDefault()
            tr = $(this).parents('tr')
            $(tr).remove()
            getTotales()
        })

        $('#btnContinuar').click(function(e){
            e.preventDefault()
            btn = $(this)
            btn.attr('disabled', true).prop('disabled', true)
            if($('#tbl-detalles tbody tr').hasClass('nodata')){
                continuar = false
                toastr['warning']('¡Verifique la información!', 'Debe agregar al menos un producto a la venta')
                btn.attr('disabled', false).prop('disabled', false)
                $.unblockUI()
            }else if($('#venta_cliente_id').val() == 1 || tipo == 1){
                total = parseFloat($('#venta-total').val())
                $('#frm-pago h4').html('agregar pago')
                $('#pago-total').val((total).toFixed(2))
                $('#frm-pago').modal('show')
                btn.attr('disabled', false).prop('disabled', false)
            }else{
                guardar()
            }
        })

        $('#pago-recibido').on('change', function(){
            total = parseFloat($('#pago-total').val())
            recibido = parseFloat($(this).val())
            if(recibido == ''){
                error('pago-recibido', 'Ingrese la cantidad con la que está pagando el cliente')
            }else if(recibido == 0){
                error('pago-recibido', 'La cantidad con la que paga el cliente debe ser mayor a 0')
            }else if(recibido < total){
                error('pago-recibido', 'La cantidad con la que paga el cliente debe ser mayor o igual al total de la venta')
            }else{
                cambio = parseFloat(recibido-total).toFixed(2)
                $('#pago-cambio').val(cambio)
            }
        })

        $('#pago-forma_pago').on('change', function(){
            val = $(this).val()
            if(val == 1) $('.infoPago').removeClass('hidden')
            else $('.infoPago').show().addClass('hidden')
        })

        $('#btnSave').click(function(e){
            e.preventDefault()
            btn = $(this)
            btn.attr('disabled', true).prop('disabled', true)
            guardar()           
        })

        $('#tbl-detalles').on('click', '.btnConcepto', function(e){
            e.preventDefault()
            tr = $(this).closest('tr')
            prod_id = tr.data('producto_id')
            concepto = $(this).text()
            $.get(apiUrl+'producto/getRangos/'+prod_id, function(resp){
                $('.name_prod').html('<b>'+concepto+'</b>')
                $.each(resp, function(index, item){
                    $('#precio-'+index).val(item).attr('disabled', true).prop('disabled', 'disabled')
                })
                mayoreo = resp.mayoreo != null ? resp.mayoreo : 0
                $('#precio-distribuidor').val(parseInt(mayoreo)+1)
            },'json')
        });

        function getRows() {
            return $('#tbl-prods tbody tr:visible');
        }

        function selectRow(index) {
             $.blockUI();
            var rows = getRows();
            delSeleccion();
            $(rows[index]).addClass('selected');
            selectedRowIndex = index;
            let producto_id = $(rows[index]).data('id');

            clave = $(rows[index]).find('td:eq(1)').text();
            desc = $(rows[index]).find('td:eq(2)').text();
            concepto = `(${clave}) ${desc}`;

            $.get(`${apiUrl}producto/getRangos/${producto_id}`, function(resp){
                $('.name_prod').html('<b>'+concepto+'</b>')
                $.each(resp, function(index, item){
                    $('#precio-'+index).val(item).attr('disabled', true).prop('disabled', 'disabled')
                })
                mayoreo = resp.mayoreo != null ? resp.mayoreo : 0
                $('#precio-distribuidor').val(parseInt(mayoreo)+1)
                $.unblockUI();
            },'json')
        }

        function addSelected(index) {
            var rows = getRows();
            let tr = $(rows[index]);
            let btn = tr.find('td:eq(4) .btn');
            btn.trigger('click');
        }

        function delSeleccion(){
            var rows = getRows();
            if (selectedRowIndex !== -1) {
                $.each($('#tbl-prods tbody tr'), function(i, e){
                    $(e).removeClass('selected');
                });
            }
        }

        function getDetalles() {
            return $('#tbl-detalles tbody tr:visible');
        }

        function selectInput(fila){
            let rows = getDetalles();
            if (rows.length > 0) {
                let tr = $(rows[fila]);
                let input = tr.find('input');
                if (input.length > 0) {
                    input.focus().select();
                }
            }
        }

        function getItems(tbl){
            cleanTable(tbl)
            $('#'+tbl+' tbody').empty()
            createTable(tbl)
        }

        function addDetalle(data, tipo=0){
            precio = data.precio == null ? parseFloat(0).toFixed(2) : data.precio  
            container = $('#tbl-detalles tbody')
            $('#tbl-detalles tbody .nodata').remove();
            tr = $('<tr class="detalle" data-detalle_id="'+data.detalle_id+'" data-producto_id="'+data.producto_id+'" data-clave="'+data.clave+'" data-stock="'+data.stock+'" data-kilo="'+data.es_kilo+'"></tr>')
            tr.append('<td class="text-start venta-cantidad" width="10%"><input type="text" class="form-control text-center cant" value="'+data.cantidad+'"></td>')
            tr.append('<td width="45%"><button type="button" class="btn btn-light btnConcepto">'+data.concepto+'</button></td>')
            tr.append('<td class="text-center precio" width="15%">$ '+precio+'</td>')
            tr.append('<td class="text-center total" width="15%">$ '+data.total+'</td>')
            td = $('<td class="text-center" width="15%"></td>').appendTo(tr)

            td.append('<button type="button" class="btn btn-outline-danger btn-sm btnDelDet" data-toogle="tooltip" title="Eliminar"><i class="fas fa-trash"></i></button>')
            container.append(tr)
            $('#frm-cantidad').modal('hide');
            $('#bus').focus();
            getTotales()
            $.unblockUI()
        }

        function addPago(data){
            metodo_pago = data.forma_pago == 1 ? 'Efectivo' : (data.forma_pago == 3 ? 'Tarjeta' : (data.forma_pago == 4 ? 'Transferencia' : ''))
            container = $('#tbl-pagos tbody')
            $('#tbl-pagos tbody .nodataPagos').remove();
            tr = $('<tr class="pago" data-pago_id="'+data.id+'"></tr>')
            tr.append('<td width="10%"><div class="d-flex flex-column"><span>'+data.date+'</span>'+'<small class="emp_post text-muted">'+data.hora+'</small></div></td>')
            tr.append('<td width="45%">'+data.usuario+'</td>')
            tr.append('<td class="text-center monto" width="15%">$ '+data.monto+'</td>')
            tr.append('<td class="text-center" width="15%">'+metodo_pago+'</td>')
            container.append(tr)
            getTotales()
            $.unblockUI()
        }

        function getTotales(){
            $.blockUI()
            let aplicar = $('#aplicar').is(':checked') ? 1 : 0;
            subtotal = 0; total = 0; pagado = 0;
            $.each($('#tbl-detalles tbody tr.detalle'), function(index, tr){
                val = parseFloat($(tr).find('.total').text().replace('$', ''))
                subtotal += val
            })
            $.each($('#tbl-pagos tbody tr.pago'), function(index, tr){
                val = parseFloat($(tr).find('.monto').text().replace('$', ''))
                pagado += val
            })
            $('#venta-subtotal').val(subtotal.toFixed(2))
            if(aplicar == 1){
                porcentaje = desc_cli
                cantDesc = parseFloat((porcentaje*subtotal)/100)
                total = parseFloat(subtotal-cantDesc-pagado)
            }else{
                total = parseFloat(subtotal-pagado)
            }
            $('#venta-total').val(total.toFixed(2))
            $.unblockUI()
        }

        function guardar(){
            subtotal = $('#venta-subtotal').is(':visible') ? $('#venta-subtotal').val() : $('#venta-total').val()
            descuento = $('#venta-descuento').is(':visible') ? $('#venta-descuento').val() : 0
            total = $('#venta-total').val()
            data = {
                cliente_id: $('#venta_cliente_id').val(),
                tipo: tipo,
                subtotal: subtotal,
                descuento: descuento,
                total: total,
                comentarios: $.trim($('#venta-comentarios').val()),
                status: 1,
            }
            data.detalles = []
            $.each($('#tbl-detalles tbody tr'), function(index, tr){
                if($(tr).is(':visible') && !$(tr).hasClass('nodata')){
                    detalle = {
                        'detalle_id': $(tr).data('detalle_id'), 
                        'clave': $(tr).data('clave'), 
                        'producto_id': $(tr).data('producto_id'), 
                        'cantidad': $(tr).find('.cant').val(),
                        'precio': $(tr).find('.precio').text().replace('$', '').replace(' ', '')
                    }
                    data.detalles.push(detalle)
                }
            })
            if($('#venta_cliente_id').val() == 1 || tipo == 1){
                continuar = false
                if($('.infoPago').is(':visible')){
                    recibido = $('#pago-recibido').val()
                    if(recibido == ''){
                        error('pago-recibido', 'Ingrese la cantidad con la que está pagando el cliente')
                        $('#btnSave').attr('disabled', false).prop('disabled', false)
                    }else if(recibido == 0){
                        error('pago-recibido', 'La cantidad con la que paga el cliente debe ser mayor a 0')
                        $('#btnSave').attr('disabled', false).prop('disabled', false)
                    }else if(parseFloat(recibido) < total){
                        error('pago-recibido', 'La cantidad con la que paga el cliente debe ser mayor o igual al total de la venta')
                        $('#btnSave').attr('disabled', false).prop('disabled', false)
                    }else{
                        cambio = parseFloat(recibido-total).toFixed(2)
                        $('#pago-cambio').val(cambio)
                        data.pago = {
                            'monto': data.total,
                            'monto_recibido': recibido,
                            'cambio': cambio,
                            'forma_pago': $('#pago-forma_pago').val()
                        }
                        continuar = true
                    }
                }else{
                    data.pago = {
                        'monto': data.total,
                        'monto_recibido': data.total,
                        'cambio': 0,
                        'forma_pago': $('#pago-forma_pago').val()
                    }
                    continuar = true
                }
            }

            if(continuar){
                if(data.cliente_id == 0 || data.cliente_id == null || isNaN(data.cliente_id)){
                    error('buscador', 'Debe seleccionar y buscar un cliente')
                    btn.attr('disabled', false).prop('disabled', false)
                    if($('#frm-pago').is(':visible')){
                        $('#frm-pago').modal('hide');
                    }
                    $.unblockUI()
                } else if(data.detalles.length == 0){
                    toastr['warning']('¡Verifique la información!', 'Debe agregar al menos un producto a la venta')
                    btn.attr('disabled', false).prop('disabled', false)
                    $.unblockUI()
                }else{
                    num_docs = data.detalles.length
                    recargar = true
                    $.post(apiUrl+'venta/add/', data, function(resp){
                        if(resp.response){
                            toastr['success']('¡Venta realizada!', 'Venta realizada con éxito')
                            ticket($.md5(resp.result.toString()))
                        }else{
                            toastr['error']('¡Error!', resp.message)
                        }
                        btn.attr('disabled', false).prop('disabled', false)
                        $.unblockUI()
                    },'json')
                }
            }
        }

        function ticket(id){
            var mywindow = window.open('<?= URL_ROOT ?>/ticket/'+id);
            var is_chrome = Boolean(mywindow.chrome);
            var mywindow2 = window.open('<?= URL_ROOT ?>/ticket/'+id);
            var is_chrome2 = Boolean(mywindow2.chrome);
    
            if (is_chrome) {
                setTimeout(function() {
                    mywindow.document.close();
                    mywindow.focus();
                    mywindow.print();
                    mywindow.close();
                }, 250);
            } else {
                mywindow.document.close();
                mywindow.focus();
                mywindow.print();
                mywindow.close();
            }
            if (is_chrome2) {
                setTimeout(function() {
                    mywindow2.document.close();
                    mywindow2.focus();
                    mywindow2.print();
                    mywindow2.close();
                    window.location.href = '<?= URL_ROOT ?>/segunda/venta'
                }, 250);
            } else {
                mywindow2.document.close();
                mywindow2.focus();
                mywindow2.print();
                mywindow2.close();
                window.location.href = '<?= URL_ROOT ?>/segunda/venta'
            }
        }

        function cleanTable(tbl){
            if($.fn.dataTable.isDataTable('#'+tbl)){
                table = $('#'+tbl).DataTable()
                table.destroy()
            }
        }

        var temporal = null;
        function evaluar(time) {
            setTimeout(() => {
                if(time == temporal) {
                    $("#tbl-prods_filter label input").val($.trim($('#bus').val())).trigger('keyup');
                }
            }, 1000);
        }

        function createTable(tbl){
            if($('#'+tbl).length){
                tabla_prods = $('#'+tbl).DataTable({
                    ajax:{
                        url: apiUrl+'producto/getAllProdsVenta',
                        type: 'GET',
                    },
                    columns: [
                        {data: 'venta'},
                        {data: 'stock'},
                        {data: 'clave'},
                        {data: 'descripcion'},
                        {data: 'medida'},
                        {data: ''}
                    ],
                    columnDefs: [
                        {
                            targets: 1,
                            render: function (data, type, full, meta) {
                            var salida =
                                '<div class="d-flex flex-column text-center">' +
                                    full['stock'] +
                                '</div>';
                                return salida;
                            }
                        },
                        {
                            targets: -1,
                            title: 'Acciones',
                            orderable: false,
                            render: function (data, type, full, meta) {
                                id = full['data_id']
                                return (
                                    '<div class="text-center">'+
                                        '<button type="button" class="btn btn-success btn-sm btnAdd" data-id="'+id+'" data-kilo="'+full['es_kilo']+'" data-toggle="tooltip" title="Agregar" style="margin-right:4px;">'+ 
                                            feather.icons['shopping-cart'].toSvg({ class: 'font-small-4 me-20' }) +
                                        '</button>'+
                                    '</div>'
                                );
                            }
                        },
                        {
                            visible: false, targets: [0]
                        }
                    ],
                    createdRow: function(row, data, dataIndex) {
                        $(row).attr('data-id', data['data_id']);
                    },
                    order: [[0, 'desc']], 
                    dom:
                        '<"d-flex justify-content-between align-items-center header-actions mx-2 row mt-75"' +
                        '<"col-sm-12 col-lg-2 d-flex justify-content-center justify-content-lg-start" f>' +
                        '<"col-sm-12 col-lg-10 ps-xl-75 ps-0"<"dt-action-buttons d-flex align-items-center justify-content-center justify-content-lg-end flex-lg-nowrap flex-wrap"<"me-1"l>>>' +
                        '>t' +
                        '<"d-flex justify-content-between mx-2 row mb-1"' +
                        '<"col-sm-12 col-md-6"i>' +
                        '<"col-sm-12 col-md-6"p>' +
                        '>',
                    language: {
                        url:'<?= URL_ROOT ?>/spanish.json'
                    },
                    initComplete: function () {
                        $('#cuantos').on('change', function () {
                            $('#tbl-prods').DataTable().page.len( $(this).val() ).draw();
                        });
                        $('#tbl-prods_filter label:eq(0)').addClass('hidden');
                        $('#tbl-prods_length label:eq(0)').addClass('hidden');
                        $('.busqueda').removeClass('hidden');
                        $('#tbl-prods tbody tr').first().addClass('selected')
                        selectRow(0);
                    }
                });

                let intervaloBusqueda = null;
                $('#tbl-prods tbody').on('mouseover', 'tr', function () {
                    const index = $(this).index();
                    if (selectedRowIndex !== index) {
                        selectRow(index);
                    }
                });

                $('#tbl-prods tbody').on('click', 'tr', function () {
                    const index = $(this).index();
                    if (selectedRowIndex !== index) {
                        selectRow(index);
                    }
                });
                $(document).on('keyup', '#bus',  function(e){
                    temporal = moment().format('x')+"-"+Math.random();
                    evaluar(temporal);
                    clearInterval(intervaloBusqueda)
                    let valor = this.value;
                    intervaloBusqueda = setInterval(function() {
                        oTable = $('#tbl-prods').DataTable();
                        oTable.search( valor ).draw();

                        clearInterval(intervaloBusqueda)
                    }, 1000);
                });
            }
        }

    });
</script>
